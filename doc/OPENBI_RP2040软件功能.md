设备软件功能说明书

# 一、功能需求

设备软件主体功能需求为：

1、设备数据的在线存储和掉电保存工作状态。需要设计UPS保证系统的突发掉电情况。

​		设备的数据类型主要有：用户参数，固件参数和运行状态等。

2、设备的通讯方式不限于但至少包括下面两种：

- RS-485 DTU协议
- TCP-IP协议	

3、主体设备功能：

- 4路输入模式功能。可以是电压输入、电流输入和数字输入。选择输入模式后，可以根据输入模式转换为模拟或者数字数据，该数据要上传至服务器端。
- 4路继电器输出功能。实时继电器状态需要监测并上传至服务器端。
- DI5、DI6两路的设定功能。并且可以根据功能设定进行数据的转换，上传至服务器端。
- 模拟电压输出功能。
- 地震传感器功能。需要测量设备自身的位移，判断设备所处环境是否处于剧烈摇晃状态，并且上传数据。
- 蓝牙参数修改功能。

# 二、软件功能模块

根据软件需求，定义以下几部分的软件功能模块：

硬件驱动部分：

- ADC
- 数字IO
- 串口
- IIC
- PWM
- DMA
- PIO

通讯应用部分：

- RS-485 DTU
- 普通串口协议，此协议适用：使用串口转TCP/IP和蓝牙串口两部分

逻辑应用部分：

- EEPROM的数据存储和读写
- 4路多模式输入
- 4路继电器输出
- 两路TTL或输入
- 多轴姿态传感器

## 通讯协议处理

setup功能：

- 判断协议类型
- 关闭其他协议，使能选定协议
- 启动协议

协议线程功能：

- 判读功能线程是否启动
- 串口/485串口/BLE串口接收数据
- 解析数据
- 系统变量更新
- 系统重启

## 4路输入功能

4路输入模式功能。

该功能需要以下几部分组成：

- 模式选择：模拟输入（电压输入/电流输入）和数字输入
- dma配置
- 数据的转换、滤波，存储与更新
- 相关寄存器地址的定义

定义读入的源数据的存储变量为 ChannelxSourceValue, 该值中x = 1 ～4。当进行完毕模式选择部分，该变量中保存的也就是相应的输入值。

如果选择模式是模拟输入，ChannelxSourceValue 被指定到dma读取地址，由外部adc io直接到ram。如果数字输入模式，ChannelxSourceValue 保存的是io的数字电平 1/0 ，此时由io的外部中断来更新该值。

经过模式选择和dma配置后，我们可以定义相关寄存器的地址。指定变量 ChannelxInputValue 为寄存器地址，它的大小为32位，低16位储存转换后数据的整数部分，高16位储存转换后数据的小数部分。

数据在转换后，处理函数可以在适当的时间进行数据的更新，滤波处理。

## 4路继电器

该部分由以下部分组成：

- 继电器选择功能，该部分选择使能哪个口。
- 继电器状态更新。
- 状态监测，更新监测状态。

读取配置参数，进行继电器的使能，未使能的继电器io不能被控制。在循环功能中，继电器状态会更新，接着会跟随状态监测功能。

## ttl5,ttl6设定

DI5、DI6两路的设定功能由以下部分组成：

- 输入/输出选择（这时，可以配置为ttl输入或者输出），高压输入模式。
- 可以使用软串口定义该io。

## 姿态传感器

这部分由以下部分组成：

- 基础数据获取
- 基础位移数据，运动预测

