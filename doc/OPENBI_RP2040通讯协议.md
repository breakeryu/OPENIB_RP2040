OPENBI_RP2040通讯协议——485Modbus

​        

# **一、MODBUS 通讯协议简介** 

MODBUS 协议是应用于电子控制器上的一种通用语言。通过此协议，控制器相互之间、控制器经由网络（例如以太网）和其它设备之间可以通信。它已经成为一通用工业标准。有了它，不同厂商生产的控制设备可以连成工业网络，进行集中监控。 

MODBUS是一个请求／应答协议，并且提供功能码规定的服务。MODBUS 是一种应用层报文传输协议，用于在通过不同类型的总线或网络连接的设备之间的客户机／服务器通信。 

**注:MODBUS是Modicon公司的注册商标。** 

## **数据编码：** 

**MODBUS 使用最高有效字节在低地址存储的方式表示地址与数据项。即当发送多个字节时，首先发送最高有效字节。** 

例如： 

| 寄存器大小 | 值     |
| ---------- | ------ |
| 16 位      | 0x1234 |

发送的第一字节为 0x12 然后发0x34 

##  **通讯数据的类型及格式：** 

信息传输为异步方式，以**字节**为单位，每字节为10 位的格式传输： 

| 字格式（串行数据） | 10 位二进制                |
| ------------------ | -------------------------- |
| 起始位             | 1 位，0                    |
| 数据位             | 8 位，最低的有效位先被发送 |
| 奇偶校验位         | 偶校验                     |
| 停止位             | 1 位，1                    |
| 波特率             | 9600bps                    |

通讯数据（信息帧）格式： 

| 数据格式 | 地址码 | 功能码 | 数据区 | CRC校验       |
| -------- | ------ | ------ | ------ | ------------- |
| 数据长度 | 1字节  | 1字节  | N字节  | 16位CRC校验码 |

 数据字节： 1个字节由8 位二进制数（8Bit）组成。 

**CRC 校验： CRC 生成后，低字节在前，高字节在后。** 

**MODBUS-RTU的帧结构：**

在RTU 模式中，新的信息总是以至少3.5个字符的静默时间开始。紧接着传送第一个域:设备地址。整帧信息必须以一个连续的数据流进行传输。如果信息结束前存在超过1.5个字符以上的间隔时间，则出错。一帧信息的标准结构如下： 

| 开始        | 地址域 | 功能域 | 数据域 | CRC校验 | 结束        |
| ----------- | ------ | ------ | ------ | ------- | ----------- |
| T1-T2-T3-T4 | 8 位   | 8位    | n*8位  | 16 位   | T1-T2-T3-T4 |

# **二、通讯信息传输过程** 

当通讯命令由发送设备（主机）发送至接收设备（从机）时，符合相应地址码的从机接收通讯命令，并根据功能码及相关要求读取信息，如果CRC 校验无误，则执行相应的任务，然后把执行结果（数据）返送给主机。返回的信息中包括地址码、功能码、数据区及CRC 校验码。如果CRC校验出错则不返回任何信息。 

 **地址码：**

地址码是每次通讯信息帧的第一字节，从0 到255。这个字节表明由用户设置地址的从机将接收由主机发送来的信息。同一总线系统内的每个从机都必须有唯一的地址码，并且只有符合地址码的从机才能响应回送信息。当从机回送信息时，回送数据均以各自的地址码开始。主机发送的地址码表明将发送到的从机地址，而从机返回的地址码表明回送的从机地址。相应的地址码表明该信息来自于何处。 

 **功能码：**

是每次通讯信息帧传送的第二个字节。MODBUS 通讯规约可定义的功能码为1到127。作为主机请求发送，通过功能码告诉从机应执行什么动作。作为从机响应，从机返回的功能码与主机发送来的功能码一样，并表明从机已响应主机并且已进行相关的操作。 

**OPENBI_RP2040**设备功能码如下表：

| 功能码  | 定义                 | 操作                                             |
| ------- | -------------------- | ------------------------------------------------ |
| **01**  | **读开关量输入**     | **读取一路或多路开关量状态输入数（遥信）**       |
| **03**  | **读寄存器数据**     | **读取一路或多路寄存器数据（遥测、参数、时间）** |
| **05**  | **写一路开关量输出** | **控制“分/合/复位”，（遥控）**                   |
| **06**  | **写单路寄存器**     | **把1组二进制数据写入单个寄存器**                |
| **10H** | **写多路寄存器**     | **把多组二进制数据写入多个寄存器**               |

 **数据区：**

数据区包括需要由从机返回何种信息或执行什么动作。这些信息可以是数据（如：开关量输入/输出、模拟量输入/输出、寄存器等等）、参考地址等。例如，主机通过功能码03告诉从机返回寄存器的值（包含要读取寄存器的起始地址及读取寄存器的长度），则返回的数据包括寄存器的数据长度及数据内容。对于不同的从机，地址和数据信息都不相同（可参照通讯信息表）。 

**CRC 校验：** 

MODBUS-RTU 通讯协议的 CRC（冗余循环码）包含 2 个字节，即 16 位二进制数。低字节在前，高字节在后。其详细说明见后页。 

 **静止时间要求：** 

 在 MODBUS-RTU 模式中，发送数据前要求数据总线静止时间即无数据发送时间至少大于 3.5 个字符的时间（如波特率 9600 时为 3.6ms）；整帧的信息必须以一个连续的数据流进行传输，如果信息结束前存在超过 1.5个字符以上的间隔时间，则出错。

# **三、MODBUS 功能码简介**

## **功能码 01（HEX）：读 1 路或多路开关量输入状态** 

 例：主机要读取地址为 01，开始地址为 **E200H** 的开关量 D0-D15 的输入状态 

主机发送的报文格式：01 01 00 00 00 10 3D C6

​					![image-20230301170914235](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301170915855-901773553.png)

从机响应返回的报文格式：01 01 02 01 02 39 AD

​        			 ![image-20230301170934135](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301170933901-901736033.png)

 

## **功能码 03（HEX）：读 1 路或多路寄存器（包括两个数据区：1.模拟量区 2.定值区）** 

 例 1：主机要读取地址为 01，开始地址为 **E000H** 的 1 个从机寄存器数据**（模拟量数据）**

主机发送的报文格式：01 03 00 00 00 01 84 0A 

​					![image-20230301171044415](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171044218-627838067.png)

从机响应返回的报文格式：01 03 02 00 64 B9 AF 

![image-20230301171057757](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171057434-1497243137.png)

 

例2：主机要读取地址为 01，开始地址为 **E100H** 的 1 个从机寄存器数据**（定值数据）**

主机发送的报文格式：01 03 01 00 00 01 85 F6

![image-20230301171131363](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171131576-974305466.png)

从机响应返回的报文格式：01 03 02 00 64 B9 AF

![image-20230301171145127](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171145479-1997924869.png)

## **功能码 05（HEX）：写一路开关量输出（遥控分合、信号复归）** 

 偏移地址“0000H”为继电器“分”位置，“0001H”为继电器“合”位置，“0002H”为继电器“信号复归”位置。“FF00”处于 ON 状态，“0000H”处于 OFF 状态。 

例：主机控制地址为 01 的从机“合”。 

主机发送的报文格式： 

 遥 控 分：01 05 00 00 FF 00 8C 3A 

 遥 控 合：01 05 00 01 FF 00 DD FA 

 遥控复归：01 05 00 02 FF 00 2D FA 

![image-20230301171215354](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171215092-537399538.png)

从机响应返回的报文格式：与主机发送的报文格式及数据内容完全相同。

## **功能码 06（HEX）：写单路寄存器** 

主机利用这个功能码把一个数据保存到从机的数据寄存器中。MODBUS 规约中寄存器是 16 位，且高位在前。

例：主机把 0065 保存到 E100H 的从机寄存器中（从机地址码为 01）。 

主机发送：01 06 01 00 00 65 48 1D 

![image-20230301171254607](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171254485-487130117.png)

从机响应返回的报文格式：与主机发送的报文格式及数据内容完全相同。 

从机返回：01 06 01 00 00 65 48 1D 

![image-20230301171311389](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171311118-1350863343.png)

## **功能码 10（HEX）：写多路寄存器** 

 主机利用这个功能码把多个数据保存到从机的数据寄存器中。MODBUS 规约中寄存器是 16 位，且高位在前。

例：主机把 0065 保存到 E100H 的从机寄存器中（从机地址码为 01）。 

 主机发送：01 10 01 00 00 01 02 00 65 76 BB

![image-20230301171330927](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171330683-1836162084.png)

从机响应返回的报文格式：与主机发送的报文格式及数据内容完全相同。 

从机返回：01 10 01 00 00 01 00 35 

![image-20230301171343716](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171343394-515514095.png)

## **功能码 10（HEX）：写多路寄存器(时间参数)**

主机利用这个功能码把多个数据保存到从机的数据寄存器中。MODBUS 规约中寄存器是 16 位，且高位在前。

例：主机把 00 年 01 月 01 日 00 时 00 分 00 秒保存到 E180H、E181H、E182H、E183H、E184H、E185H 的从机寄存器中（从机地址码为 01）。 

 主机发送： 01 10 01 80 00 06 0C 00 00 00 01 00 01 00 00 00 00 00 00 27 B7 

![image-20230301171412017](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171411787-513218080.png)

从机响应返回的报文格式：与主机发送的报文格式及数据内容完全相同。 

从机返回：01 10 01 80 00 06 40 1F 

![image-20230301171427739](https://img2023.cnblogs.com/blog/1423856/202303/1423856-20230301171427442-1939608098.png)

# **四、错误校验码（CRC 校验）**

使用MODBUS-RTU 模式，消息包括了一基于CRC 方法的错误检测域。CRC 域检测了整个消息的内容。 

主机或从机可用校验码进行判别接收信息是否正确。由于电子噪声或一些其它干扰，信息在传输过程中有时会发生错误，错误校验码（CRC）可以检验主机或从机在通讯数据传送过程中的信息是否有误，错误的数据可以放弃，这样增加了系统的可靠性及通讯效率。 

CRC 域是两个字节，包含一16 位的二进制值。它由传输设备计算后加入到消息中。接收设备重新计算收到消息的CRC，并与接收到的CRC 域中的值比较，如果两值不同，则有误。 

在进行CRC 计算时只用8 个数据位，起始位及停止位和奇偶校验位都不参与CRC 计算。 

## **CRC 码的计算方法是：** 

1．预置1 个全“1”的16 位CRC 寄存器（0xFFFF）（即全为1）; 

2．把第一个8 位二进制数据（既信息帧的第一个字节）与16 位的CRC 寄存器的低8 位相异或（XOR），

把结果放于CRC 寄存器的低8 位； 

3．把CRC 寄存器的内容右移一位（朝低位）,用0 填补最高位，并检查右移后的移出位； 

4．如果移出位为1,则CRC 寄存器与预置的值A001（1010 0000 0000 0001）异或一下; 如果移出位为0，

则不进行。 

5．重复8 次步骤3 和4，对整个8 位数据全部进行处理； 

6．重复按步骤2 到5 的方法，进行通讯信息帧的下一个字节处理； 

7．将该通讯信息帧所有字节按上述步骤计算完成后，得到16 位的CRC 值； 

8．CRC 添加到消息中时，低字节先加入，然后高字节。 

# **五、各指令对应的地址范围**

## 读开关量输入（01命令）

起始地址：E010H

| 线圈起始地址 |       位定义       | 事件代码（HEX） |
| :----------: | :----------------: | :-------------: |
|    E010H     |    设备停止状态    |       ——        |
|    E011H     |    设备运行状态    |       ——        |
|    E012H     |      蓝牙开启      |       ——        |
|    E013H     |        备用        |       ——        |
|    E014H     |    继电器1开启     |       ——        |
|    E015H     |    继电器2开启     |       ——        |
|    E016H     |    继电器3开启     |       ——        |
|    E017H     |    继电器4开启     |       ——        |
|     08H      |   输入通道1开启    |       ——        |
|     09H      |   输入通道2开启    |       ——        |
|     0AH      |   输入通道3开启    |       ——        |
|     0BH      |   输入通道4开启    |       ——        |
|     0CH      |   EEPROM设备错误   |       0x1       |
|     0DH      | 震动传感器设备错误 |       0x2       |
|     0FH      |        备用        |       ——        |

## **写开关量输出（05命令）**

地址范围：**E100H**

| 线圈起始地址 | 位定义                                       |
| ------------ | -------------------------------------------- |
| E100H        | 系统复位                                     |
| E101H        | 继电器1状态<br />⏹继电器闭合 1 ⏹继电器断开 0 |
| E102H        | 继电器2状态<br />⏹继电器闭合 1 ⏹继电器断开 0 |
| E103H        | 继电器3状态<br />⏹继电器闭合 1 ⏹继电器断开 0 |
| E104H        | 继电器4状态<br />⏹继电器闭合 1 ⏹继电器断开 0 |
| E105H        | LED状态<br />⏹亮 1 ⏹灭 0                     |
|              |                                              |
|              |                                              |

## 读多路寄存器（03命令）

地址范围：**E000H—E017H （模拟量）**

| 寄存器地址 |                数据类型                | 系数 |
| :--------: | :------------------------------------: | :--: |
|   E000H    | 输入通道1模拟电流/电压值 (单位：mA/mV) |  ——  |
|   E001H    | 输入通道2模拟电流/电压值 (单位：mA/mV) |  ——  |
|   E002H    | 输入通道3模拟电流/电压值 (单位：mA/mV) |  ——  |
|   E003H    | 输入通道4模拟电流/电压值 (单位：mA/mV) |  ——  |
|    04H     |        加速度Ax（单位：m/s^2）         |  ——  |
|    05H     |        加速度Ay（单位：m/s^2）         |  ——  |
|    06H     |        加速度Az（单位：m/s^2）         |  ——  |
|    07H     |         角速度Wx（单位：°/s）          |  ——  |
|    08H     |         角速度Wy（单位：°/s）          |  ——  |
|    09H     |         角速度Wz（单位：°/s）          |  ——  |
|            |            温度（单位：°C）            |      |
|    0AH     |           角度x轴（单位：°）           |  ——  |
|    0BH     |           角度y轴（单位：°）           |  ——  |
|    0CH     |           角度z轴（单位：°）           |  ——  |
|    0DH     |            气压（单位：Pa）            |  ——  |
|    0FH     |            高度（单位：cm）            |  ——  |

**注：读出的数据应该乘以系数：Rg数据×10＝实际值**

**U**的单位为“**V**“，**I**的单位为“**A**”，**P**的单位为“**kW**”，**Q**的单位为“**kVar**”，**Rg**的单位为“**Ω**”

## 读多路寄存器（03命令）

地址范围：**E100H—E113H （系统配置定值参数）**

| 寄存器地址 |                 数据类型                 | 系数  |
| :--------: | :--------------------------------------: | :---: |
|   E100H    |   通讯系统配置时间超时阈值（单位：ms）   |  ——   |
|   E101H    | 逻辑控制系统配置时间超时阈值（单位：ms） |  ——   |
|   E102H    |       蓝牙串口波特率（单位：baud）       |  ——   |
|   E103H    |      RS485串口波特率（单位：baud）       |  ——   |
|    04H     |              设备硬件版本_H              |  ——   |
|    05H     |              设备硬件版本_L              |  ——   |
|    06H     |              设备软件版本_H              |  ——   |
|    07H     |              设备软件版本_L              |  ——   |
|    08H     |         输入通道1模拟电流/电压值         | 0.001 |
|    09H     |         输入通道2模拟电流/电压值         | 0.001 |
|    0AH     |         输入通道3模拟电流/电压值         | 0.001 |
|    0BH     |         输入通道4模拟电流/电压值         | 0.001 |
|    0CH     |                                          |  ——   |
|    0DH     |                   备用                   |  ——   |
|    0FH     |                   备用                   |  ——   |

**注：读出的数据应该乘以系数：以短路倍数为例：短路倍数=短路倍数实际值*0.01**

## 写单路寄存器（06命令）、写多路寄存器（10命令）

地址范围：**E100H—E113H** **（定值参数）**

| 寄存器地址 |                           数据类型                           | 系数 |
| :--------: | :----------------------------------------------------------: | :--: |
|   E100H    |            模拟输出电压（单位：mV，范围：0~10V）             |  1   |
|   E101H    |                           短路倍数                           | 100  |
|   E102H    |                            欠压值                            | 1000 |
|   E103H    | **Channel_1输入使能**，配置功能如下：<br />⏹使能通道输入 1  ⏹关闭通道输入 0 |  ——  |
|   E104H    | **Channel_2输入使能**，配置功能如下：<br />⏹使能通道输入 1  ⏹关闭通道输入 0 |  ——  |
|   E105H    | **Channel_3输入使能**，配置功能如下：<br />⏹使能通道输入 1  ⏹关闭通道输入 0 |  ——  |
|   E116H    | **Channel_4输入使能**，配置功能如下：<br />⏹使能通道输入 1  ⏹关闭通道输入 0 |  ——  |
|   E107H    | **Channel_1输入模式配置**，写入值对应功能如下：<br />⏹模拟电压输入 0x00        ⏹模拟电流输入 0x01   ⏹数字输入  0x02          <br />❗注意：当输入Channel_1输入使能为0时，该通道关闭，这种情况下，即使配置通道功能，通道配置也会失效！要想配置通道，要首先使本通道的输入使能配置为1。 |  ——  |
|   E108H    | **Channel_2输入模式配置**，写入值对应功能如下：<br />⏹模拟电压输入 0x00        ⏹模拟电流输入 0x01   ⏹数字输入  0x02           <br />❗注意：当输入Channel_2输入使能为0时，该通道关闭，这种情况下，即使配置通道功能，通道配置也会失效！要想配置通道，要首先使本通道的输入使能配置为1。 |  ——  |
|   E105H    | **Channel_3输入模式配置**，写入值对应功能如下：<br />⏹模拟电压输入 0x00        ⏹模拟电流输入 0x01   ⏹数字输入  0x02        <br />❗注意：当输入Channel_3输入使能为0时，该通道关闭，这种情况下，即使配置通道功能，通道配置也会失效！要想配置通道，要首先使本通道的输入使能配置为1。 |  ——  |
|   E109H    | **Channel_4输入模式配置**，写入值对应功能如下：<br />⏹模拟电压输入 0x00        ⏹模拟电流输入 0x01   ⏹数字输入  0x02            <br />❗注意：当输入Channel_4输入使能为0时，该通道关闭，这种情况下，即使配置通道功能，通道配置也会失效！要想配置通道，要首先使本通道的输入使能配置为1。 |  ——  |
|   E110H    | **继电器通道数配置**，写入值对应功能如下：<br />⏹全部开启 0x00        ⏹使能1路继电器 0x01   ⏹使能两路继电器  0x02  ⏹使能三路继电器  0x03 |  ——  |
|            |                                                              |      |
|            |                                                              |      |

**注：读出的数据应该乘以系数：以模拟输出电压为例：模拟输出电压=模拟输出电压实际值*100**

##  **写多路寄存器（10命令）**

地址范围：**E180H—E185H （读取模块运行后的时间参数）**

| 寄存器地址 | 数据类型 |
| ---------- | -------- |
| E180H      | 年       |
| E181H      | 月       |
| E182H      | 日       |
| E183H      | 时       |
| E184H      | 分       |
| E185H      | 秒       |



 

 

